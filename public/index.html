<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Reciclaje</title>
</head>
<body>

  <h1>Gestión del Reciclaje</h1>

  <!-- Sección: Registrar Bote -->
  <section>
    <h2>Registrar Bote de Basura</h2>
    <form id="form-bote">
      <input type="text" name="ubicacion" placeholder="Ubicación del bote" required><br>
      <select name="reciclaje">
        <option value="plastico">Plástico</option>
        <option value="papel">Papel</option>
        <option value="vidrio">Vidrio</option>
        <option value="organico">Orgánico</option>
      </select><br>
      <button type="submit">Registrar Bote</button>
    </form>
  </section>

  <!-- Sección: Registrar Material -->
  <section>
    <h2>Registrar Material Reciclable</h2>
    <form id="form-material">
      <input type="text" name="material" placeholder="Nombre del material" required><br>
      <select name="reciclaje">
        <option value="plastico">Plástico</option>
        <option value="papel">Papel</option>
        <option value="vidrio">Vidrio</option>
        <option value="organico">Orgánico</option>
      </select><br>
      <button type="submit">Registrar Material</button>
    </form>
  </section>

  <!-- Sección: Registrar Participante -->
  <section>
    <h2>Registrar Participante</h2>
    <form id="form-participante">
      <input type="text" name="nombre" placeholder="Nombre completo" required><br>
      <select name="rol">
        <option value="estudiante">Estudiante</option>
        <option value="docente">Docente</option>
        <option value="administrativo">Administrativo</option>
      </select><br>
      <input type="number" name="kilos" placeholder="Kilos reciclados" required><br>
      <input type="text" name="fecha" placeholder="Fecha (AAAA-MM-DD)" pattern="\d{4}-\d{2}-\d{2}" required><br>
      <input type="text" name="lugar" placeholder="Lugar de recolección"><br>
      <button type="submit">Registrar Participación</button>
    </form>
  </section>

  <!-- Sección: Registrar Ruta -->
  <section>
    <h2>Registrar Ruta de Recolección</h2>
    <form id="form-ruta">
      <input type="text" name="zona" placeholder="Zona o sector" required><br>
      <input type="text" name="hora" placeholder="Hora (HH:MM)" pattern="^([01]\d|2[0-3]):([0-5]\d)$" required><br>
      <input type="text" name="descripcion" placeholder="Descripción o puntos de recolección"><br>
      <button type="submit">Registrar Ruta</button>
    </form>
  </section>

  <!-- Sección: Visualización de todos los datos -->
  <section>
    <h2>Visualizar Todos los Registros</h2>
    <button onclick="mostrarTodos()">Ver Todo</button>
    <div id="tabla-todos"></div>
  </section>

  <script>
    // Reutilizar para todos los formularios
    async function enviarFormulario(formId, url, tipo) {
      document.getElementById(formId).addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = Object.fromEntries(new FormData(form));
        formData.tipo = tipo; // Añadir campo tipo según modelo
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        if (res.ok) {
          alert('Registro exitoso');
          form.reset();
        } else {
          alert('Error al registrar');
        }
      });
    }

    // Conectar formularios
    enviarFormulario('form-bote', '/api/botes', 'bote');
    enviarFormulario('form-material', '/api/materiales', 'material');
    enviarFormulario('form-participante', '/api/participantes', 'participante');
    enviarFormulario('form-ruta', '/api/rutas', 'ruta');

    // Mostrar todos los datos en una tabla unificada
    async function mostrarTodos() {
      const contenedor = document.getElementById('tabla-todos');
      contenedor.innerHTML = '';

      try {
        const res = await fetch('/api/todos');
        const datos = await res.json();

        if (datos.length === 0) {
          contenedor.textContent = 'No hay registros aún.';
          return;
        }

        const tabla = document.createElement('table');
        tabla.border = '1';
        tabla.style.marginTop = '20px';

        // Encabezado dinámico
        const encabezado = tabla.insertRow();
        const columnas = Object.keys(datos[0]).filter(k => k !== '__v' && k !== '_id');
        columnas.forEach(clave => {
          const th = document.createElement('th');
          th.textContent = clave.toUpperCase();
          encabezado.appendChild(th);
        });

        // Filas de datos
        datos.forEach(item => {
          const fila = tabla.insertRow();
          columnas.forEach(clave => {
            const celda = fila.insertCell();
            celda.textContent = item[clave] || '';
          });
        });

        contenedor.appendChild(tabla);

      } catch (err) {
        console.error('Error al cargar todos los datos', err);
        contenedor.textContent = 'Error al cargar datos.';
      }
    }
  </script>

</body>
</html>
